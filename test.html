<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OTP Reader Plugin Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 2rem auto;
            padding: 1rem;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            border: none;
            border-radius: 4px;
            background: #007AFF;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056CC;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .result {
            background: #f8f9fa;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            border-left: 4px solid #007AFF;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        input {
            width: 100%;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OTP Reader Plugin Test</h1>
        
        <div id="status">Waiting for device ready...</div>
        
        <h3>Debug & Diagnostics</h3>
        <button id="getDebugInfo" disabled>Get Debug Info</button>
        <button id="testOTPExtraction">Test OTP Extraction</button>
        
        <h3>Basic Functions</h3>
        <button id="startListening" disabled>Start Listening for OTP</button>
        <button id="stopListening" disabled>Stop Listening</button>
        <button id="getPhoneNumber" disabled>Get Device Phone Number</button>
        
        <h3>Advanced Testing</h3>
        <input type="text" id="senderPhone" placeholder="Sender phone number (optional)">
        <button id="startWithSender" disabled>Start Listening with Sender Filter</button>
        
        <h3>OTP Extraction Test</h3>
        <input type="text" id="testMessage" placeholder="Enter SMS message to test OTP extraction">
        <input type="number" id="otpLength" value="6" min="4" max="10" placeholder="OTP Length">
        <button id="testExtraction">Test OTP Extraction</button>
        
        <h3>Results</h3>
        <div id="results"></div>
    </div>

    <script>
        let isListening = false;
        
        // Wait for device ready
        document.addEventListener('deviceready', onDeviceReady, false);
        
        function onDeviceReady() {
            updateStatus('Device ready!');
            
            // Check if plugin is available
            if (cordova.plugins && cordova.plugins.OTPReader) {
                updateStatus('OTP Reader plugin available!', 'success');
                enableButtons();
            } else {
                updateStatus('OTP Reader plugin not found!', 'error');
            }
        }
        
        function enableButtons() {
            document.getElementById('startListening').disabled = false;
            document.getElementById('getPhoneNumber').disabled = false;
            document.getElementById('getDebugInfo').disabled = false;
            document.getElementById('startWithSender').disabled = false;
        }
        
        function updateStatus(message, type = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type;
        }
        
        function addResult(message, type = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result ' + type;
            resultDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Event listeners
        document.getElementById('startListening').addEventListener('click', function() {
            if (isListening) return;
            
            addResult('Starting OTP listener...');
            
            cordova.plugins.OTPReader.startListening(
                null, // No sender filter
                function(result) {
                    addResult('OTP Result: ' + JSON.stringify(result, null, 2), 'success');
                    
                    if (result.success && result.message) {
                        const otp = cordova.plugins.OTPReader.extractOTP(result.message, 6);
                        addResult('Extracted OTP: ' + otp, 'success');
                    }
                },
                function(error) {
                    addResult('OTP Error: ' + error, 'error');
                    isListening = false;
                    updateListeningState();
                }
            );
            
            isListening = true;
            updateListeningState();
        });
        
        document.getElementById('stopListening').addEventListener('click', function() {
            addResult('Stopping OTP listener...');
            
            cordova.plugins.OTPReader.stopListening(
                function() {
                    addResult('Stopped listening successfully', 'success');
                    isListening = false;
                    updateListeningState();
                },
                function(error) {
                    addResult('Stop error: ' + error, 'error');
                }
            );
        });
        
        document.getElementById('getDebugInfo').addEventListener('click', function() {
            addResult('Getting debug information...');
            
            cordova.plugins.OTPReader.getDebugInfo(
                function(debugInfo) {
                    addResult('Debug Info: ' + JSON.stringify(debugInfo, null, 2), 'success');
                },
                function(error) {
                    addResult('Debug info error: ' + error, 'error');
                }
            );
        });
        
        document.getElementById('getPhoneNumber').addEventListener('click', function() {
            addResult('Getting device phone number...');
            
            cordova.plugins.OTPReader.getPhoneNumber(
                function(phoneNumber) {
                    addResult('Device phone number: ' + phoneNumber, 'success');
                    document.getElementById('senderPhone').value = phoneNumber;
                },
                function(error) {
                    addResult('Phone number error: ' + error, 'error');
                }
            );
        });
        
        document.getElementById('startWithSender').addEventListener('click', function() {
            if (isListening) return;
            
            const senderPhone = document.getElementById('senderPhone').value.trim();
            
            addResult('Starting OTP listener with sender: ' + (senderPhone || 'any'));
            
            cordova.plugins.OTPReader.startListening(
                senderPhone || null,
                function(result) {
                    addResult('Filtered OTP Result: ' + JSON.stringify(result, null, 2), 'success');
                    
                    if (result.success && result.message) {
                        const otp = cordova.plugins.OTPReader.extractOTP(result.message, 6);
                        addResult('Extracted OTP: ' + otp, 'success');
                    }
                },
                function(error) {
                    addResult('Filtered OTP Error: ' + error, 'error');
                    isListening = false;
                    updateListeningState();
                }
            );
            
            isListening = true;
            updateListeningState();
        });
        
        document.getElementById('testExtraction').addEventListener('click', function() {
            const message = document.getElementById('testMessage').value;
            const length = parseInt(document.getElementById('otpLength').value) || 6;
            
            if (!message) {
                addResult('Please enter a test message', 'error');
                return;
            }
            
            if (cordova.plugins && cordova.plugins.OTPReader) {
                const otp = cordova.plugins.OTPReader.extractOTP(message, length);
                
                if (otp) {
                    addResult('Extracted OTP from "' + message + '": ' + otp, 'success');
                } else {
                    addResult('No OTP found in "' + message + '"', 'error');
                }
            } else {
                // Fallback extraction for testing without device
                const regex = new RegExp('\\b\\d{' + length + '}\\b');
                const match = message.match(regex);
                const otp = match ? match[0] : null;
                
                if (otp) {
                    addResult('Extracted OTP (fallback): ' + otp, 'success');
                } else {
                    addResult('No OTP found (fallback)', 'error');
                }
            }
        });
        
        function updateListeningState() {
            document.getElementById('startListening').disabled = isListening;
            document.getElementById('startWithSender').disabled = isListening;
            document.getElementById('stopListening').disabled = !isListening;
            
            updateStatus(isListening ? 'Listening for SMS...' : 'Ready', 
                         isListening ? '' : 'success');
        }
        
        // Test extraction even without device
        if (!window.cordova) {
            updateStatus('Running in browser - limited functionality');
            document.getElementById('testExtraction').disabled = false;
        }
        
        // Add some test messages for quick testing
        const testMessages = [
            "Your verification code is 123456",
            "OTP: 654321",
            "Code 789012 expires in 10 minutes",
            "Use 345678 to verify your account",
            "234567 is your login code"
        ];
        
        const testMessageSelect = document.createElement('select');
        testMessageSelect.innerHTML = '<option value="">Choose test message...</option>';
        testMessages.forEach(msg => {
            const option = document.createElement('option');
            option.value = msg;
            option.textContent = msg;
            testMessageSelect.appendChild(option);
        });
        
        testMessageSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('testMessage').value = this.value;
            }
        });
        
        document.getElementById('testMessage').parentNode.insertBefore(testMessageSelect, 
                                                                     document.getElementById('testMessage'));
    </script>
</body>
</html>
